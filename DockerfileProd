FROM cirrusci/flutter:1.17.5 AS builder
LABEL stage=flutter-builder

WORKDIR /app
COPY . .
USER root
RUN flutter build appbundle --flavor prod -t lib/program.dart

FROM ruby:2.7.1 AS ruby
LABEL stage=flutter-deployer

WORKDIR /app
COPY --from=builder /app /app
WORKDIR /app/android
RUN bundle install
RUN bundle exec fastlane deploy